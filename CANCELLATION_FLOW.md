# Новый Алгоритм Отмены Бронирования

## Что изменилось

### Проблема (было):
Когда пользователь писал "Привет. Я хочу отменить бронирование", система пыталась автоматически извлечь ФИО из сообщения и ошибочно считала "хочу отменить бронирование" за имя гостя.

### Решение (стало):
Создан интерактивный диалог, который:
1. **Определяет намерение** - распознает запрос на отмену
2. **Запрашивает данные** - показывает форму поиска с примерами
3. **Выполняет умный поиск** - ищет по ФИО, email, телефону или ID
4. **Показывает результаты** - отображает найденные бронирования с кнопками действий
5. **Подтверждает операцию** - запрашивает подтверждение перед отменой

## Новые Возможности

### 1. Интерактивная Форма Поиска
- Красивое поле ввода с кнопкой поиска
- Примеры для каждого типа параметра
- Поиск по Enter или клику на кнопку
- Автофокус на поле ввода

### 2. Умное Извлечение Параметров
Система распознает:
- **ID бронирования**: BKG-ABC123
- **Email**: ivanov@example.com
- **Телефон**: +380501234567
- **ФИО**: только после ключевых слов ("для", "на имя", "по имени")

### 3. Защита от Ложных Срабатываний
- Фильтрация служебных слов (хочу, отменить, бронирование и т.д.)
- Проверка на минимальное количество слов в имени (2+)
- Строгие паттерны для ФИО

### 4. Повторные Попытки
- До 3 попыток поиска с подсказками
- После 3 неудачных попыток - предложение обратиться к администратору
- Сохранение контекста между попытками

### 5. Отслеживание Состояния
```javascript
cancellationState = {
  isActive: false,           // Активен ли процесс отмены
  action: null,              // 'cancel_only' | 'cancel_and_rebook'
  stage: 'initial',          // 'initial' | 'awaiting_search_params' | 'awaiting_confirmation'
  searchAttempts: 0,         // Счетчик попыток поиска
  lastSearchType: null       // Последний использованный тип поиска
}
```

## Сценарии Использования

### Сценарий 1: Запрос без параметров
**Пользователь пишет:**
```
Привет. Я хочу отменить бронирование
```

**Система отвечает:**
1. Сообщение: "Давайте найдем ваше бронирование. Укажите любой известный вам параметр:"
2. Показывает интерактивную форму поиска с примерами
3. Ждет ввода данных пользователем

**Пользователь вводит:**
```
Іванов Петро Сергійович
```

**Система:**
1. Ищет бронирования по этому имени
2. Показывает найденные бронирования с кнопками "Скасувати" и "Змінити"

---

### Сценарий 2: Запрос с указанием ФИО
**Пользователь пишет:**
```
Отменить бронирование для Петренко Марина Олександрівна
```

**Система:**
1. Извлекает ФИО из сообщения (после ключевого слова "для")
2. Сразу выполняет поиск
3. Показывает найденные бронирования

---

### Сценарий 3: Поиск по email
**Пользователь пишет:**
```
Хочу изменить бронирование ivanov@example.com
```

**Система:**
1. Определяет email в сообщении
2. Ищет бронирования по этому email
3. Показывает результаты

---

### Сценарий 4: Поиск по ID
**Пользователь пишет:**
```
Отменить BKG-ABC123
```

**Система:**
1. Определяет ID бронирования
2. Находит точное совпадение
3. Показывает бронирование

---

### Сценарий 5: Бронирование не найдено
**Пользователь вводит:**
```
Несуществующий Гость
```

**Система:**
1. Сообщает: "Бронирования по параметру ФИО "Несуществующий Гость" не найдены"
2. Предлагает попробовать другой параметр
3. Показывает форму поиска снова (попытка 1 из 3)

**После 3 неудачных попыток:**
```
Если у вас возникли сложности с поиском, обратитесь к администратору.
```

## Технические Детали

### Функции

#### `showBookingSearchForm()`
Создает и отображает интерактивную форму поиска бронирования

#### `performBookingSearch(searchValue, formContainer)`
- Извлекает параметры из введенного значения
- Выполняет поиск в базе данных
- Обрабатывает результаты
- Управляет счетчиком попыток

#### `extractBookingSearchParams(message)`
Улучшенная функция извлечения параметров:
- Проверяет формат ID, email, телефона
- Извлекает ФИО только после ключевых слов
- Фильтрует служебные слова
- Возвращает `{ type, value }` или `{ type: null, value: null }`

#### `handleBookingCancellationByName(userMessage)`
Главная функция запуска процесса отмены:
- Активирует состояние отмены
- Пытается извлечь параметры из начального сообщения
- Если не нашла - показывает форму
- Если нашла - сразу выполняет поиск

#### `resetCancellationState()`
Сбрасывает состояние процесса отмены

### Интеграция с Существующим Кодом

#### В `getAIResponse()`:
```javascript
// Проверка намерения отменить
const hasCancellationIntent = detectCancellationIntent(userMessage);

// Запуск процесса отмены
if (hasCancellationIntent && !cancellationState.isActive) {
  handleBookingCancellationByName(userMessage);
  return;
}

// Обработка последующих сообщений в процессе отмены
if (cancellationState.isActive && cancellationState.stage === 'awaiting_search_params') {
  performBookingSearch(userMessage, document.getElementById('booking-search-form'));
  return;
}
```

## Тестирование

### Подготовка:
1. Откройте админ-панель
2. Нажмите "Тестові" в секции бронирований
3. Закройте админ-панель
4. Откройте чат

### Тест 1: Без параметров
```
Пользователь: Привет. Я хочу отменить бронирование
Ожидается: Форма поиска с примерами
```

### Тест 2: С указанием ФИО после ключевого слова
```
Пользователь: Отменить бронирование для Іванов Петро Сергійович
Ожидается: Сразу показываются найденные бронирования
```

### Тест 3: Только ФИО без ключевого слова
```
Пользователь: Іванов Петро Сергійович
(в процессе отмены, в форме поиска)
Ожидается: Поиск и показ результатов
```

### Тест 4: По email
```
Пользователь: ivanov@example.com
Ожидается: Поиск по email и показ результатов
```

### Тест 5: По телефону
```
Пользователь: +380501234567
Ожидается: Поиск по телефону и показ результатов
```

### Тест 6: Несуществующее бронирование
```
Пользователь: Несуществующий Гость
Ожидается: Сообщение об отсутствии, форма снова (попытка 1/3)
```

### Тест 7: Отмена бронирования
```
1. Найти бронирование
2. Нажать "Скасувати"
3. Подтвердить в alert
Ожидается: Успешная отмена + сообщение
```

### Тест 8: Изменение бронирования
```
1. Найти бронирование
2. Нажать "Змінити"
3. Подтвердить в alert
Ожидается: Отмена текущего + предложение создать новое
```

## Стилизация

Добавлены стили в `css/bookings.css`:
- `.booking-search-form` - контейнер формы
- Стили для input с фокусом
- Hover и active эффекты для кнопки поиска

## Безопасность

- Все данные хранятся локально
- Подтверждение перед любой операцией
- Защита от SQL-injection (используется фильтрация)
- Ограничение попыток поиска (3 максимум)

---

**Статус**: ✅ Готово к тестированию
**Дата**: 2026-01-17
